<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>♬報酬表電卓</title>
<style>
:root{--bg:#0b0b0c;--card:#14171a;--muted:#9aa4ad;--accent-1:#1e90ff;--orange:#ff9500;--dark-btn:#0b0b0c;font-family: sans-serif;}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);color:#fff;-webkit-font-smoothing:antialiased}
.app{max-width:820px;margin:8px auto;padding:12px;display:flex;flex-direction:column;gap:12px}
.header{display:flex;justify-content:space-between;align-items:center}
.title{font-weight:900;font-size:19px}

.top{display:flex;gap:12px;align-items:flex-start}
.left{flex:2;background:linear-gradient(180deg,var(--card),#0c0f11);border-radius:12px;padding:10px;min-height:160px;max-height:240px;overflow:auto;border:1px solid rgba(255,255,255,0.08)}
.right{width:240px;background:linear-gradient(180deg,#07080a,#0b0d10);border-radius:12px;padding:14px;border:1px solid rgba(255,255,255,0.06)}

.entry{display:flex;justify-content:space-between;align-items:center;padding:10px 8px;border-bottom:1px solid rgba(255,255,255,0.05)}
.entry .label{font-weight:800;font-size:15px}
.entry .price{font-variant-numeric:tabular-nums;color:#fff;min-width:100px;text-align:right;font-weight:900}
.removeBtn{background:#ff6b6b;border:0;color:#fff;font-weight:900;cursor:pointer;margin-left:12px;width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;}

.grid-wrap{background:transparent;border-radius:12px;padding:4px}
.buttons{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}

.btn-base {
    border-radius: 12px;
    padding: 12px 2px;
    min-height: 68px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    font-weight: 900;
    font-size: 15px;
    border: 1px solid rgba(0,0,0,0.3);
    box-shadow: 0 6px 14px rgba(0,0,0,0.6);
    transition: transform .06s;
    cursor: pointer;
    line-height: 1.25;
}
.btn-base:active{transform:translateY(3px);}

.btn-const{ color:var(--dark-btn); }
.btn-const.dark{ background:linear-gradient(180deg, #ff7f50, #ff6347); color:#fff; }
.btn-const.ac-dark{ background:linear-gradient(180deg, #ff4500, #cc3700); color:#fff; }
/* 追加：青いボタン用スタイル */
.btn-blue{ background:linear-gradient(180deg, #1e90ff, #007bff); color:#fff; }
.btn-travel{ background:linear-gradient(180deg, #90ee90, #4ecb71) !important; color:#004d40 !important; }
.btn-free{ background:#ffffff; color:#000; border:1px solid #999; }
.btn-placeholder{background:transparent; min-height:64px; border:none;}

.free-group{margin-top:4px;background:rgba(255,255,255,0.04);border-radius:14px;padding:15px;border:1px solid rgba(255,255,255,0.08);}
.free-label{font-size:14px; font-weight:900; color:#ddd; margin-bottom:8px; display:block;}
.free-input{width:100%; background:#fff; border:2px solid #555; padding:12px; border-radius:10px; text-align:right; color:#000; font-size:24px; font-weight:bold; outline:none;}
.coeff-row{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:12px;}

.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:99;background:rgba(0,0,0,0.9)}
.panel{width:94%;max-width:760px;max-height:86vh;overflow:auto;background:#111;border-radius:16px;padding:24px;}
.form-row{display:flex;gap:10px;align-items:center;margin-bottom:12px;}
.form-row label{min-width:140px;color:var(--muted);font-size:14px;font-weight:800;}
.form-row input{padding:10px;border-radius:8px;border:1px solid #444;background:#000;color:#fff;flex:1;}

@media(max-width:520px){
    .top{flex-direction:column;}
    .right{width:100%;}
    .btn-base{font-size:14px;}
}
</style>
</head>
<body>
<div class="app">
    <div class="header">報酬表電卓 <div><div class="title"></divv<div style=""font-size:11px;font-weight:700;color:var(--muted;">V8 Final Version</div></div>
        <div style="display:flex; gap:12px; align-items:center;">
            <select id="rankSelector" style="padding:8px; background:#222; color:#fff; border:1px solid #444; border-radius:6px; font-weight:bold;"></select>
            <button id="openSettings" style="background:#333; color:#fff; border:none; padding:10px 14px; border-radius:8px; font-weight:900;">⚙</button>
        </div>
    </div>
    <div class="top"><div class="left" id="stack"></div><div class="right">
        <div style="display:flex;justify-content:space-between;font-weight:900;font-size:17px;"><span>税抜</span><span id="preTax">0</span></div>
        <div style="display:flex;justify-content:space-between;margin-top:10px;font-weight:900;font-size:17px;"><span>消費税(<span id="taxRate">10</span>%)</span><span id="tax">0</span></div>
        <hr style="border:0; border-top:2px solid #333; margin:12px 0;"><div style="display:flex;justify-content:space-between; color:var(--orange); font-size:26px; font-weight:900; letter-spacing:-1px;"><span>合計</span><span id="total">0</span></div>
    </div></div>

    <div id="mainButtons" class="grid-wrap"><div class="buttons" id="buttonsArea"></div></div>
    <div class="grid-wrap"><div class="buttons" id="controlBtnsArea"></div></div>
    
    <div class="free-group">
        <label class="free-label">自由入力（金額を入れて下のボタンを押す）</label>
        <input id="freeValue" class="free-input" type="number" placeholder="0" inputmode="numeric">
        <div class="coeff-row" id="freeBtnsArea"></div>
    </div>
</div>

<div class="modal" id="modal"><div class="panel">
    <h3 style="font-weight:900;">⚙ SETTINGS</h3>
    <div class="form-row"><label>消費税率(%)</label><input id="taxInput" type="number"></div>
    <div class="form-row"><label>丸め</label><select id="roundMethod" style="padding:10px;background:#000;color:#fff;width:100%;border-radius:8px;"><option value="floor">切り捨て</option><option value="ceil">切り上げ</option></select></div>
    <h4 style="border-bottom:2px solid #333;padding-bottom:5px;font-weight:900;">定数単価編集</h4><div id="buttonConfigArea"></div>
    <h4 style="border-bottom:2px solid #333;padding-bottom:5px;font-weight:900;">自由掛け率編集</h4><div id="freeConfigArea"></div>
    <button id="saveSettingsBtn" style="background:var(--accent-1);color:#fff;padding:18px;width:100%;border:none;border-radius:12px;font-weight:900;margin-top:20px;font-size:16px;">設定を保存して閉じる</button>
    <button id="importPriceTableBtn" style="background:#00bcd4;color:#fff;padding:12px;width:100%;border:none;border-radius:8px;margin-top:10px;font-weight:800;">ランク表インポート</button>
    <button onclick="document.getElementById('modal').style.display='none'" style="background:#222;color:#999;padding:12px;width:100%;border:none;border-radius:8px;margin-top:10px;font-weight:800;">キャンセル</button>
    <input type="file" id="importPriceTableFile" accept=".txt,.csv,.tsv" style="display:none;" />
</div></div>

<script>
const DEFAULT_RANKS = ["H", "G", "F", "E", "D", "C", "B", "A", "S", "SS", "SSS"];
const CFG_KEY = "rewardcalc_v22_final_perfect_v2";
const scrollToTop = () => window.scrollTo({ top: 0, behavior: 'smooth' });

let cfg = JSON.parse(localStorage.getItem(CFG_KEY)) || {
    taxRate: 10, roundMethod: "floor", currentRank: "S",
    buttons: [
        {name:"定期UP 14000", prices:{H:6775,G:7462,F:7855,E:8149,D:8444,C:8836,B:9425,A:9524,S:9818,SS:10113,SSS:10211}},
        {name:"定期GP 17500", prices:{H:8444,G:9327,F:9818,E:10211,D:10505,C:10996,B:11684,A:11880,S:12273,SS:12567,SSS:12764}},
        {name:"普通UP 16000", prices:{H:7756,G:8542,F:9033,E:9327,D:9622,C:10113,B:10702,A:10898,S:11193,SS:11487,SSS:11684}},
        {name:"普通GP 19500", prices:{H:9425,G:10407,F:10996,E:11389,D:11684,C:12273,B:13058,A:13255,S:13647,SS:14040,SSS:14236}},
        {name:"音教備品UP", prices:{S:6382}},{name:"音教備品GP", prices:{S:7855}},
        {name:"納調UP (新品/中古)", prices:{S:5891}},{name:"納調GP (新品/中古)", prices:{S:8836}},
        {name:"店頭UP (名店)", prices:{S:6382}},{name:"店頭GP (名店)", prices:{S:7953}},
        {name:"店頭UP (RPS)", prices:{S:6382}},{name:"店頭GP (RPS)", prices:{S:8836}},
        {name:"学校UP", prices:{D:5302, S:5891}},{name:"学校GP", prices:{D:6578, S:7265}},
        {name:"学校CF/S", prices:{D:7855, S:8542}},{name:"学校SW/B", prices:{D:8247, S:8935}},
        {name:"ヤマハホール", prices:{S:12764}},
        {name:"出張費3000", prices:{S:2356}},{name:"出張費3500", prices:{S:2847}},{name:"出張費4000", prices:{S:3338}},
        {name:"日当", prices:{S:19636}},{name:"除湿剤 1600", prices:{S:655}},
        {name:"予備23", prices:{S:0}},{name:"予備24", prices:{S:0}}
    ],
    freeButtons: [
        {name:"修理(%)", isRanked:true, prices:{H:0.7364, G:0.7364, F:0.7364, E:0.7855, D:0.7855, C:0.7855, B:0.8836, A:0.8836, S:0.8836}, roundMethod:"ceil"},
        {name:"クレーム(%)", coeff:0.6873, roundMethod:"ceil"},
        {name:"部品代", coeff:1.0, roundMethod:"ceil"},
        {name:"立会い", coeff:0.864, roundMethod:"ceil"},
        {name:"コンサート(%)", isRanked:false, coeff:0.7658, roundMethod:"ceil100"},
        {name:"割増・調整", isRanked:false, coeff:0.8836, roundMethod:"ceil"},
        {name:"予備7", coeff:1.0, roundMethod:"ceil"},
        {name:"予備8", coeff:1.0, roundMethod:"ceil"}
    ]
};

let entries = [];
const save = () => localStorage.setItem(CFG_KEY, JSON.stringify(cfg));

function renderButtons(){
    const area = document.getElementById("buttonsArea"); area.innerHTML = "";
    cfg.buttons.forEach((b, i) => {
        const btn = document.createElement("button"); 
        const isTravel = b.name.includes("出張費");
        btn.className = "btn-base btn-const" + (isTravel ? " btn-travel" : "");
        if(!isTravel) {
            const isDark = (i % 4 === 0 || i % 4 === 2);
            btn.style.background = isDark ? 'linear-gradient(180deg, #334c66, #243b55)' : 'linear-gradient(180deg, #e3f2fd, #bbdefb)';
            btn.style.color = isDark ? '#fff' : '#000';
        }
        const p = b.prices[cfg.currentRank] || b.prices["S"] || 0;
        btn.innerHTML = `<div>${b.name}</div><div style="font-size:12px;opacity:0.8;font-weight:700;">${p.toLocaleString()}</div>`;
        btn.onclick = () => { entries.push({name:b.name, price:p}); updateUI(); scrollToTop(); };
        area.appendChild(btn);
    });
}

function renderFreeButtons(){
    const area = document.getElementById("freeBtnsArea"); area.innerHTML = "";
    cfg.freeButtons.forEach(f => {
        const btn = document.createElement("button"); btn.className = "btn-base btn-free";
        const val = f.isRanked ? (f.prices[cfg.currentRank] || f.coeff || 1) : (f.coeff || 1);
        btn.innerHTML = `<div>${f.name}</div><div style="font-size:12px;font-weight:700;">× ${val}</div>`;
        btn.onclick = () => {
            const v = Number(document.getElementById("freeValue").value);
            if(!v) return alert("金額を入力してください");
            let raw = v * val;
            let price = f.roundMethod === "ceil100" ? Math.ceil(raw/100)*100 : Math.ceil(raw);
            entries.push({name:f.name, price:price});
            updateUI(); document.getElementById("freeValue").value = ""; scrollToTop();
        };
        area.appendChild(btn);
    });
}

// 修正：コントロールボタン描画関数
function renderControlButtons(){
    const area = document.getElementById("controlBtnsArea"); area.innerHTML = "";
    
    // 1列目：汎用早見表
    const blue = document.createElement("button");
    blue.className = "btn-base btn-blue";
    blue.innerHTML = "汎用<br>早見表";
    blue.onclick = () => window.open('https://betsunoid.github.io/hayamihyo/', '_blank');
    
    // 2列目：空白
    const empty = Object.assign(document.createElement("div"), {className:"btn-placeholder"});
    
    // 3列目：Cボタン
    const c = document.createElement("button"); 
    c.className = "btn-base btn-const dark"; 
    c.innerHTML = "C"; 
    c.onclick = () => { entries.pop(); updateUI(); scrollToTop(); };
    
    // 4列目：ACボタン
    const ac = document.createElement("button"); 
    ac.className = "btn-base btn-const ac-dark"; 
    ac.innerHTML = "AC"; 
    ac.onclick = () => { entries = []; updateUI(); scrollToTop(); };
    area.append(blue, empty, c, ac);
}

function updateUI(){
    const area = document.getElementById("stack"); area.innerHTML = "";
    let sub = 0;
    entries.forEach((e, i) => {
        sub += e.price;
        const row = document.createElement("div"); row.className = "entry";
        row.innerHTML = `<div class="label">${e.name}</div><div style="display:flex;align-items:center;"><div class="price">${e.price.toLocaleString()}</div><button class="removeBtn" onclick="entries.splice(${i},1);updateUI();">×</button></div>`;
        area.appendChild(row);
    });
    const tax = Math.floor(sub * cfg.taxRate / 100);
    document.getElementById("preTax").textContent = sub.toLocaleString();
    document.getElementById("tax").textContent = tax.toLocaleString();
    document.getElementById("total").textContent = (sub+tax).toLocaleString();
    document.getElementById("taxRate").textContent = cfg.taxRate;
}

document.getElementById("openSettings").onclick = () => {
    document.getElementById("modal").style.display = "flex";
    document.getElementById("taxInput").value = cfg.taxRate;
    document.getElementById("roundMethod").value = cfg.roundMethod;
    const bArea = document.getElementById("buttonConfigArea"); bArea.innerHTML = "";
    cfg.buttons.forEach((b, i) => {
        const row = document.createElement("div"); row.className = "form-row";
        row.innerHTML = `<span style="width:30px;font-weight:900;">${i+1}</span><input id="bn${i}" type="text" value="${b.name}"><input id="bv${i}" type="number" value="${b.prices[cfg.currentRank]||0}">`;
        bArea.appendChild(row);
    });
    const fArea = document.getElementById("freeConfigArea"); fArea.innerHTML = "";
    cfg.freeButtons.forEach((f, i) => {
        const row = document.createElement("div"); row.className = "form-row";
        const val = f.isRanked ? (f.prices[cfg.currentRank]||0) : f.coeff;
        row.innerHTML = `<span style="width:30px;font-weight:900;">${i+1}</span><input id="fn${i}" type="text" value="${f.name}"><input id="fc${i}" type="number" step="0.0001" value="${val}">`;
        fArea.appendChild(row);
    });
};

document.getElementById("saveSettingsBtn").onclick = () => {
    cfg.taxRate = Number(document.getElementById("taxInput").value);
    cfg.roundMethod = document.getElementById("roundMethod").value;
    cfg.buttons.forEach((b, i) => {
        b.name = document.getElementById(`bn${i}`).value;
        b.prices[cfg.currentRank] = Number(document.getElementById(`bv${i}`).value);
    });
    cfg.freeButtons.forEach((f, i) => {
        f.name = document.getElementById(`fn${i}`).value;
        const val = Number(document.getElementById(`fc${i}`).value);
        if(f.isRanked) f.prices[cfg.currentRank] = val; else f.coeff = val;
    });
    save(); renderButtons(); renderFreeButtons(); updateUI();
    document.getElementById("modal").style.display = "none";
};

document.getElementById("importPriceTableBtn").onclick = () => document.getElementById("importPriceTableFile").click();
document.getElementById("importPriceTableFile").onchange = (ev) => {
    const file = ev.target.files[0]; if(!file) return;
    const r = new FileReader();
    r.onload = e => {
        const lines = e.target.result.split('\n');
        lines.forEach(line => {
            const cols = line.split(/\t|,/);
            if(cols.length < 2) return;
            const name = cols[0].trim();
            const target = cfg.buttons.find(b => b.name === name) || cfg.freeButtons.find(b => b.name === name && b.isRanked);
            if(target){
                DEFAULT_RANKS.forEach((rank, idx) => {
                    if(cols[idx+1]) target.prices[rank] = Number(cols[idx+1].replace(/,/g,''));
                });
            }
        });
        save(); renderButtons(); renderFreeButtons(); updateUI(); alert("ランク表を更新しました");
    };
    r.readAsText(file);
};

const rs = document.getElementById("rankSelector");
rs.innerHTML = DEFAULT_RANKS.map(r => `<option value="${r}" ${r===cfg.currentRank?'selected':''}>${r}</option>`).join("");
rs.onchange = (e) => { cfg.currentRank = e.target.value; save(); renderButtons(); renderFreeButtons(); updateUI(); };

renderButtons(); renderFreeButtons(); renderControlButtons(); updateUI();

window.onload = () => {
    const target = document.getElementById('mainButtons');
    if (target) target.scrollIntoView();
};
</script>
</body>
</html>

