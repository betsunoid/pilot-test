<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>♬積算電卓 V26.9</title>
<style>
:root{--bg:#0b0b0c;--card:#14171a;--accent:#1e90ff;--orange:#ff9500;--red:#f44336;font-family:sans-serif;}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:#fff;font-size:14px;overflow-x:hidden;}
.app{max-width:820px;margin:0 auto;padding:12px;display:flex;flex-direction:column;gap:12px;min-height:100vh;}
.header{display:flex;justify-content:space-between;align-items:center}
.display-area{display:flex;gap:12px;}
@media(max-width:600px){.display-area{flex-direction:column;}.total-view{width:100%!important;}}
.stack-view{flex:2;background:var(--card);border-radius:12px;padding:5px;height:180px;overflow-y:auto;border:1px solid #333;}
.total-view{width:240px;background:#000;border-radius:12px;padding:15px;border:1px solid #333;}

/* 個別削除行のデザイン修正 */
.entry{display:flex;align-items:center;padding:10px 8px;border-bottom:1px solid #222;font-variant-numeric:tabular-nums;cursor:pointer;}
.entry:active{background:#333;}
.entry-name{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.entry-price{margin:0 10px;font-weight:bold;}
/* 赤丸白抜きのバツ印 */
.del-btn {
    width: 22px; height: 22px; background: var(--red); color: #fff;
    border-radius: 50%; display: flex; align-items: center; justify-content: center;
    font-size: 14px; font-weight: bold; line-height: 1; margin-left: 4px;
}

.grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;}
.btn-blue{background:linear-gradient(180deg,#334c66,#243b55);color:#fff;} 
.btn-lblue{background:linear-gradient(180deg,#e3f2fd,#bbdefb);color:#000;} 
.btn-green{background:linear-gradient(180deg,#90ee90,#4ecb71);color:#004d40;} 
.btn{border-radius:12px;padding:8px 2px;min-height:80px;border:none;font-weight:900;cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;touch-action:manipulation;}
.btn-free{background:#fff;color:#000;min-height:70px;font-size:11px;}
.free-input{width:100%;padding:15px;font-size:24px;text-align:right;border-radius:12px;border:none;background:#fff;color:#000;font-weight:bold;}

#m { position:fixed; inset:0; background:rgba(0,0,0,0.9); display:none; align-items:center; justify-content:center; z-index:1000; }
.panel{width:98%;max-width:800px;max-height:95vh;background:#000;border-radius:24px;padding:15px;overflow-y:auto;border:1px solid #444;}
.config-header{display:grid;grid-template-columns:1.5fr 1fr 1fr;gap:8px;padding:0 5px 10px;font-weight:bold;font-size:12px;color:var(--accent);text-align:center;}
.config-item{display:grid;grid-template-columns:1.5fr 1fr 1fr;gap:8px;margin-bottom:8px;}
.config-item input{background:#111;color:#fff;border:1px solid #333;padding:10px;border-radius:8px;font-size:12px;width:100%;}
.cmd-btn{padding:16px;border-radius:12px;border:none;font-weight:bold;cursor:pointer;color:#fff;text-align:center;font-size:14px;}
</style>
</head>
<body>
<div class="app">
    <div class="header">
        <div style="font-size:19px;font-weight:900">♬積算電卓 V26.9</div>
        <div style="display:flex;gap:8px">
            <select id="rSel" style="padding:8px;background:#222;color:#fff;border-radius:6px;border:1px solid #444;"></select>
            <button onclick="openCfg()" style="background:#333;color:#fff;border:none;padding:10px;border-radius:8px;cursor:pointer">⚙ 設定</button>
        </div>
    </div>

    <div class="display-area">
        <div id="stack" class="stack-view"></div>
        <div class="total-view">
            <div style="display:flex;justify-content:space-between;font-size:12px;color:#9aa4ad"><span>税抜報酬</span><span id="sub">0</span></div>
            <div style="display:flex;justify-content:space-between;font-size:12px;color:#9aa4ad;margin-top:4px"><span id="taxLabel">消費税(10%)</span><span id="tax">0</span></div>
            <div style="display:flex;justify-content:space-between;font-size:22px;font-weight:900;color:var(--orange);margin-top:10px;border-top:1px solid #333;padding-top:10px">
                <span>合計</span><span id="tot">0</span>
            </div>
        </div>
    </div>

    <div id="g1" class="grid"></div>
    <div class="grid" style="margin-top:8px">
        <button class="btn" style="background:var(--accent);color:#fff" onclick="window.open('https://betsunoid.github.io/hayamihyo/')">汎用早見表</button>
        <div></div>
        <button class="btn" style="background:var(--orange);color:#fff" onclick="pop()">C</button>
        <button class="btn" style="background:var(--red);color:#fff" onclick="ac()">AC</button>
    </div>

    <div style="background:rgba(255,255,255,0.05);padding:15px;border-radius:15px;margin-top:12px">
        <div style="font-size:11px;color:var(--accent);margin-bottom:8px;text-align:center;font-weight:bold;">金額を入力してから下の係数ボタンを押してください</div>
        <input type="number" id="fVal" class="free-input" placeholder="金額入力" inputmode="numeric">
        <div id="g2" class="grid" style="margin-top:12px"></div>
    </div>
</div>

<div id="m">
    <div class="panel">
        <div style="background:#1a1a1a;padding:15px;border-radius:15px;margin-bottom:20px;border:1px solid var(--accent);">
            <h4 style="margin:0 0 10px 0;color:var(--accent);">基本設定</h4>
            <div style="display:flex;align-items:center;gap:15px;">
                <span>消費税率 (%) :</span>
                <input type="number" id="cfgTax" style="background:#000;color:#fff;border:1px solid #444;padding:8px;border-radius:5px;width:80px;" value="10">
            </div>
        </div>

        <h3 style="text-align:center">⚙ 定数ボタン設定</h3>
        <div class="config-header"><span>定数名</span><span>報酬</span><span>顧客請求額</span></div>
        <div id="cButtons"></div>
        <h3 style="text-align:center;margin-top:20px;">⚙ 係数ボタン設定</h3>
        <div id="cFree"></div>
        
        <button onclick="save()" class="cmd-btn" style="background:#4a90e2;width:100%;margin:20px 0;">設定を適用して閉じる</button>
        
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
            <input type="file" id="fileInp" style="display:none" accept="image/*,application/pdf">
            <button class="cmd-btn" style="background:#f39c12;" onclick="document.getElementById('fileInp').click()">PDF・画像から読込</button>
            <button onclick="gen()" class="cmd-btn" style="background:#5ab55e;">最新HTMLを生成</button>
            <button class="cmd-btn" style="background:#5bc0de;" onclick="imp()">インポート</button>
            <button class="cmd-btn" style="background:#777;" onclick="exp()">バックアップ</button>
            <button onclick="if(confirm('設定をリセットしますか？')){localStorage.clear();location.reload();}" class="cmd-btn" style="background:#e74c3c;grid-column:span 2;">リセット</button>
            <button onclick="closeCfg()" class="cmd-btn" style="background:#333;grid-column:span 2;">キャンセル</button>
        </div>
    </div>
</div>

<script>
const M = {
    "teikiUP": {H:6775, G:7462, F:7855, E:8149, D:8444, C:8836, B:9425, A:9524, S:9818, SS:10113, SSS:10211},
    "teikiGP": {H:8444, G:9327, F:9818, E:10211, D:10505, C:10996, B:11684, A:11880, S:12273, SS:12567, SSS:12764},
    "futsuUP": {H:7756, G:8542, F:9033, E:9327, D:9622, C:10113, B:10702, A:10898, S:11193, SS:11487, SSS:11684},
    "futsuGP": {H:9425, G:10407, F:10996, E:11389, D:11684, C:12273, B:13058, A:13255, S:13647, SS:14040, SSS:14236},
    "gakkoUP": {H:4811, G:4811, F:4811, E:4811, D:5302, C:5302, B:5891, A:5891, S:5891, SS:5891, SSS:5891},
    "gakkoGP": {H:5793, G:5793, F:5793, E:5793, D:6578, C:6578, B:7265, A:7265, S:7265, SS:7265, SSS:7265},
    "gakkoCFS":{H:0, G:0, F:0, E:0, D:7560, C:7560, B:7560, A:8542, S:8542, SS:8542, SSS:8542},
    "gakkoSWB":{H:0, G:0, F:0, E:0, D:0, C:0, B:0, A:8935, S:8935, SS:8935, SSS:8935},
    "shuri":   {H:0.7364, G:0.7364, F:0.7364, E:0.7855, D:0.7855, C:0.7855, B:0.8836, A:0.8836, S:0.8836, SS:0.8836, SSS:0.8836},
    "nichito": {H:13745, G:14727, F:15709, E:16691, D:17673, C:18655, B:19636, A:19636, S:19636, SS:19636, SSS:19636}
};

let cfg = JSON.parse(localStorage.getItem("calc_v26_final")) || {
    rank:"S", taxRate: 10,
    btns: [
        {n:"定期UP",v:"teikiUP",c:"14000"}, {n:"定期GP",v:"teikiGP",c:"17500"},
        {n:"普通UP",v:"futsuUP",c:"16000"}, {n:"普通GP",v:"futsuGP",c:"19500"},
        {n:"新品納調UP",v:5891,c:""}, {n:"新品納調GP",v:8836,c:""},
        {n:"中古納調UP",v:5891,c:""}, {n:"中古納調GP",v:8836,c:""},
        {n:"店頭UP(名古屋店)",v:6382,c:""}, {n:"店頭GP(名古屋店)",v:7953,c:""},
        {n:"店頭UP(RPS)",v:6382,c:""}, {n:"店頭GP(RPS)",v:8836,c:""},
        {n:"学校UP",v:"gakkoUP",c:""}, {n:"学校GP",v:"gakkoGP",c:""},
        {n:"学校CF/S",v:"gakkoCFS",c:""}, {n:"学校SW/B",v:"gakkoSWB",c:""},
        {n:"出張費3000",v:2356,c:"3000"}, {n:"出張費3500",v:2847,c:"3500"},
        {n:"出張費4000",v:3338,c:"4000"}, {n:"出張費B",v:1473,c:""},
        {n:"日当",v:"nichito",c:""}, {n:"音教備品UP",v:6382,c:""},
        {n:"音教備品GP",v:7855,c:""}, {n:"ヤマハホール",v:12764,c:""},
        {n:"除湿剤",v:655,c:1600}, {n:"未登録",v:0,c:""}, {n:"未登録",v:0,c:""}, {n:"未登録",v:0,c:""}
    ],
    fBtns: [
        {n:"修理(%)",co:"shuri"}, {n:"部品代",co:1.0}, {n:"調整・割増",co:0.8836}, {n:"再調律",co:0.8836},
        {n:"コンサート",co:0.7658}, {n:"立会い",co:0.864}, {n:"早夜割増",co:0.864}, {n:"GPS調律",co:0.6873},
        {n:"ピアノ診断",co:0.6873}, {n:"管理・保守",co:0.6873}, {n:"YMJ補填",co:0.6873}, {n:"予備",co:1.0}
    ]
};

let data = [];
function update(){
    const s = document.getElementById("stack"); s.innerHTML = ""; let sum = 0;
    const tRate = cfg.taxRate || 10;
    data.forEach((x, i) => { 
        sum += x.p; 
        s.innerHTML += `
        <div class="entry" onclick="del(${i})">
            <span class="entry-name">${x.n}</span>
            <span class="entry-price">${Math.round(x.p).toLocaleString()}</span>
            <span class="del-btn">×</span>
        </div>`; 
    });
    document.getElementById("taxLabel").innerText = `消費税(${tRate}%)`;
    document.getElementById("sub").innerText = Math.round(sum).toLocaleString();
    document.getElementById("tax").innerText = Math.floor(sum * (tRate/100)).toLocaleString();
    document.getElementById("tot").innerText = Math.floor(sum * (1 + tRate/100)).toLocaleString();
    s.scrollTop = s.scrollHeight;
    window.scrollTo(0,0);
}
function del(i){ data.splice(i, 1); update(); }
function draw(){
    const g1 = document.getElementById("g1"); g1.innerHTML = "";
    cfg.btns.forEach((b, i) => {
        const v = M[b.v] ? M[b.v][cfg.rank] : Number(b.v);
        const el = document.createElement("button");
        let col = i % 4;
        let colorClass = (col === 0 || col === 2) ? "btn-blue" : "btn-lblue";
        if (b.n.includes("出張費")) colorClass = "btn-green";
        el.className = "btn " + colorClass;
        el.innerHTML = `<div style="font-size:10px">${b.n}</div><div style="font-size:16px">${Math.round(v).toLocaleString()}</div><div style="font-size:9px;opacity:0.6;">(${b.c||'-'})</div>`;
        el.onclick = () => { if(v>0){data.push({n:b.n,p:v});update();} };
        g1.appendChild(el);
    });
    const g2 = document.getElementById("g2"); g2.innerHTML = "";
    cfg.fBtns.forEach(f => {
        const c = M[f.co] ? (M[f.co][cfg.rank] || M[f.co]) : Number(f.co);
        const el = document.createElement("button"); el.className = "btn btn-free";
        el.innerHTML = `<div style="font-size:10px">${f.n}</div><div>×${typeof c === 'number' ? c.toFixed(4) : c}</div>`;
        el.onclick = () => { const v = document.getElementById("fVal").value; if(v){data.push({n:f.n,p:v*c});update();document.getElementById("fVal").value="";} };
        g2.appendChild(el);
    });
}
function openCfg(){ document.getElementById("m").style.display="flex"; renderCfg(); }
function closeCfg(){ document.getElementById("m").style.display="none"; }
function renderCfg(){
    document.getElementById("cfgTax").value = cfg.taxRate || 10;
    const d1 = document.getElementById("cButtons"); d1.innerHTML = "";
    cfg.btns.forEach((b,i)=>{ 
        d1.innerHTML += `<div class="config-item"><input id="bn${i}" value="${b.n}"><input id="bv${i}" value="${b.v}"><input id="bc${i}" value="${b.c}"></div>`;
    });
    const d2 = document.getElementById("cFree"); d2.innerHTML = "";
    cfg.fBtns.forEach((f,i)=>{ 
        d2.innerHTML += `<div class="config-item"><input id="fn${i}" value="${f.n}" style="grid-column:span 1.5"><input id="fc${i}" value="${f.co}" style="grid-column:span 1.5"></div>`;
    });
}
function save(){
    cfg.taxRate = Number(document.getElementById("cfgTax").value);
    cfg.btns.forEach((b,i)=>{ b.n=document.getElementById(`bn${i}`).value; let v=document.getElementById(`bv${i}`).value; b.v=isNaN(v)?v:Number(v); b.c=document.getElementById(`bc${i}`).value; });
    cfg.fBtns.forEach((f,i)=>{ f.n=document.getElementById(`fn${i}`).value; let c=document.getElementById(`fc${i}`).value; f.co=isNaN(c)?c:Number(c); });
    localStorage.setItem("calc_v26_final", JSON.stringify(cfg));
    closeCfg(); draw(); update();
}
function pop(){ data.pop(); update(); }
function ac(){ data = []; update(); }
function gen(){ 
    document.getElementById("m").style.display = "none";
    const html = document.documentElement.outerHTML; 
    const b = new Blob([html],{type:"text/html"}); 
    const a = document.createElement("a"); a.href=URL.createObjectURL(b); a.download="calc_v26_9.html"; a.click(); 
}
function exp(){ const s = JSON.stringify(cfg); const b = new Blob([s],{type:"application/json"}); const a = document.createElement("a"); a.href=URL.createObjectURL(b); a.download="backup.json"; a.click(); }
function imp(){ const i = document.createElement("input"); i.type="file"; i.accept=".json"; i.onchange = (e) => { const r = new FileReader(); r.onload = (f) => { cfg = JSON.parse(f.target.result); save(); location.reload(); }; r.readAsText(e.target.files[0]); }; i.click(); }

window.onload = () => {
    document.getElementById("m").style.display = "none";
    const s = document.getElementById("rSel");
    ["H","G","F","E","D","C","B","A","S","SS","SSS"].forEach(r=>{ const o=document.createElement("option"); o.value=o.text=r; if(r==cfg.rank)o.selected=true; s.add(o); });
    s.onchange = (e) => { cfg.rank=e.target.value; draw(); update(); };
    draw(); update();
};
</script>
</body>
</html>

